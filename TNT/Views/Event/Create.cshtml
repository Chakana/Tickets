@model TNT.Models.Eventos

@{
    ViewBag.Title = "Create";
}

<script>
    jQuery(window).load(function () {
        var sectoresItems = [];
        $("#Upload").click(function () {
            var formData = new FormData();
            var totalFiles = document.getElementById("FileUpload").files.length;
            for (var i = 0; i < totalFiles; i++) {
                var file = document.getElementById("FileUpload").files[i];

                formData.append("FileUpload", file);
            }
            $.ajax({
                type: "POST",
                url: '/Home/Upload',
                data: formData,
                dataType: 'json',
                contentType: false,
                processData: false,
                success: function (response) {
                    $('#img_url').val(response);
                },
                error: function (error) {
                    alert("errror");
                }
            });
        });
        $('#submit').click(function () {
            //validation of order
            var isAllValid = true;

            //Save if valid
            var id_empresa = $('#id_empresa').val();
            if (id_empresa == 'undefined') {
                id_empresa = '';
            }
            if (isAllValid) {
                var data = {
                    descripcion: $('#descripcion').val().trim(),
                    fecha_evento: $('#fecha_evento').val().trim(),
                    hora_evento: $('#hora_evento').val().trim(),
                    id_empresa: id_empresa,
                    id_lugar: $('#id_lugar').val().trim(),
                    id_tipo_evento: $('#id_tipo_evento').val().trim(),
                    img_url: $('#img_url').val().trim(),
                    nombre_evento: $('#nombre_evento').val().trim(),
                    sectores: sectoresItems,
                    nit_facturacion: $('#nit_facturacion').val().trim(),
                    nombre_empresa_facturacion: $('#nombre_empresa_facturacion').val().trim(),
                    numero_autorizacion_facturacion: $('#numero_autorizacion_facturacion').val().trim(),
                    rubro_facturacion: $('#rubro_facturacion').val().trim(),
                    telefono_facturacion: $('#telefono_facturacion').val().trim(),
                    departamento_facturacion: $('#departamento_facturacion').val().trim(),
                    direccion_facturacion: $('#direccion_facturacion').val().trim()
                }


                $.ajax({
                    url: '/Event/GrabarEventoSector',
                    type: "POST",
                    data: JSON.stringify(data),
                    dataType: "JSON",
                    contentType: "application/json",
                    beforeSend: function () {
                        $('#modalback').modal('toggle');
                    },
                    complete: function () {
                        $('#modalback').modal('toggle');
                    },
                    success: function (d) {
                        //check is successfully save to database
                        if (d.status == true) {
                            //will send status from server side
                            $('#modalGrabadoOK').modal('show');
                            //clear form
                            sectoresItems = [];
                            window.location.href = "/Event/Index";
                        }
                        else {
                            $('#modalGrabadoFail').modal('show');
                        }

                    },
                    error: function () {
                        $('#modalGrabadoFail').modal('show');
                    }
                });
            }

        });

        $('#add').click(function () {

            //Check validation of order item
            var isValidItem = true;
            //Add item to list if valid

            if (isValidItem) {
                sectoresItems.push({
                    descripcion: $('#descripcionSector').val().trim(),
                    precio_unitario: parseInt($('#precio_unitario').val().trim()),
                    asientos_disponibles: $('#asientos_disponibles').val().trim(),
                    filas: $('#filas').val().trim(),
                    columnas: $('#columnas').val().trim()
                });

                //Clear fields
                $('#descripcionSector').val('').focus();
                $('#descripcionSector,#precio_unitario,#asientos_disponibles').val('');
            }
            //populate order items
            console.log(sectoresItems);
            GeneratedItemsTable();

        });
        function GeneratedItemsTable() {
            if (sectoresItems.length > 0) {
                var $table = $('<table class="table table-hover"/>');
                $table.append('<thead><tr><th>Descripcion</th><th>Precio Unitario</th><th>Asientos Disponibles</th><th>Filas</th><th>Columnas</th></tr></thead>');
                var $tbody = $('<tbody/>');
                $.each(sectoresItems, function (i, val) {
                    var $row = $('<tr/>');
                    $row.append($('<td/>').html(val.descripcion));
                    $row.append($('<td/>').html(val.precio_unitario));
                    $row.append($('<td/>').html(val.asientos_disponibles));
                    $row.append($('<td/>').html(val.filas));
                    $row.append($('<td/>').html(val.columnas));
                    $tbody.append($row);
                });
                $table.append($tbody);
                $('#sectorItems').html($table);
            }
        }
    });

    
   
</script>

<h2>Crear Evento</h2>


<div class="col-xs-6">
    <fieldset>
        <legend>Eventos</legend>

        <div class="editor-label">
            @Html.LabelFor(model => model.nombre_evento)
        </div>
        <div class="editor-field">
            @Html.EditorFor(model => model.nombre_evento)
            @Html.ValidationMessageFor(model => model.nombre_evento)
        </div>

        <div class="editor-label">
            @Html.LabelFor(model => model.id_lugar, "Lugares")
        </div>
        <div class="editor-field">
            @Html.DropDownList("id_lugar", String.Empty)
            @Html.ValidationMessageFor(model => model.id_lugar)
        </div>

        <div class="editor-label">
            @Html.LabelFor(model => model.fecha_evento)
        </div>
        <div class="editor-field">
            @Html.TextBoxFor(model => model.fecha_evento, new { type = "date" })
            @Html.ValidationMessageFor(model => model.fecha_evento)
        </div>
        <div class="editor-label">
            @Html.LabelFor(model => model.hora_evento)
        </div>
        <div class="editor-field">
            @Html.TextBoxFor(model => model.hora_evento, new { type = "time" })
            @Html.ValidationMessageFor(model => model.hora_evento)
        </div>
        @if (User.IsInRole("admin"))
        {
            <div class="editor-label">
                @Html.LabelFor(model => model.id_empresa, "Empresas")
            </div>
            <div class="editor-field">
                @Html.DropDownList("id_empresa", String.Empty)
                @Html.ValidationMessageFor(model => model.id_empresa)
            </div>
        }
        <div class="editor-label">
            @Html.LabelFor(model => model.id_tipo_evento, "Tipo Evento")
        </div>
        <div class="editor-field">
            @Html.DropDownList("id_tipo_evento", String.Empty)
            @Html.ValidationMessageFor(model => model.id_tipo_evento)
        </div>

        <div class="editor-label">
            @Html.LabelFor(model => model.img_url, "Banner")
        </div>
        <div class="editor-field">
            @Html.EditorFor(model => model.img_url)
            @Html.ValidationMessageFor(model => model.img_url)
            <input type="file" id="FileUpload" />
            <input type="button" id="Upload" value="Subir Archivo" class="btn btn-info" />
        </div>
        <div class="editor-label">
            @Html.LabelFor(model => model.descripcion)
        </div>
        <div class="editor-field">
            @Html.TextAreaFor(model => model.descripcion)
            @Html.ValidationMessageFor(model => model.descripcion)
        </div>
        <span>Solo rellene los siguientes datos si el evento va tener su propia facturacion, caso contrario dejelos en blanco, se tomara automaticamente los datos de la empresa credora del evento</span>
        <div class="editor-label">
            @Html.LabelFor(model => model.nit_facturacion)
        </div>
        <div class="editor-field">
            @Html.TextAreaFor(model => model.nit_facturacion)
            @Html.ValidationMessageFor(model => model.nit_facturacion)
        </div>
        <div class="editor-label">
            @Html.LabelFor(model => model.nombre_empresa_facturacion)
        </div>
        <div class="editor-field">
            @Html.TextAreaFor(model => model.nombre_empresa_facturacion)
            @Html.ValidationMessageFor(model => model.nombre_empresa_facturacion)
        </div>
        <div class="editor-label">
            @Html.LabelFor(model => model.numero_autorizacion_facturacion)
        </div>
        <div class="editor-field">
            @Html.TextAreaFor(model => model.numero_autorizacion_facturacion)
            @Html.ValidationMessageFor(model => model.numero_autorizacion_facturacion)
        </div>
        <div class="editor-label">
            @Html.LabelFor(model => model.rubro_facturacion)
        </div>
        <div class="editor-field">
            @Html.TextAreaFor(model => model.rubro_facturacion)
            @Html.ValidationMessageFor(model => model.rubro_facturacion)
        </div>
        <div class="editor-label">
            @Html.LabelFor(model => model.telefono_facturacion)
        </div>
        <div class="editor-field">
            @Html.TextAreaFor(model => model.telefono_facturacion)
            @Html.ValidationMessageFor(model => model.telefono_facturacion)
        </div>
        <div class="editor-label">
            @Html.LabelFor(model => model.departamento_facturacion)
        </div>
        <div class="editor-field">
            @Html.TextAreaFor(model => model.departamento_facturacion)
            @Html.ValidationMessageFor(model => model.departamento_facturacion)
        </div>
        <div class="editor-label">
            @Html.LabelFor(model => model.direccion_facturacion)
        </div>
        <div class="editor-field">
            @Html.TextAreaFor(model => model.direccion_facturacion)
            @Html.ValidationMessageFor(model => model.direccion_facturacion)
        </div>

        <p>
            <button id="submit" type="submit" class="btn btn-primary">Grabar Evento</button>

        </p>
    </fieldset>
</div>
<div class="col-xs-6">
    <div class="row">
        <h2>Sectores</h2>
        <table class="table table-hover">
            <tr>
                <td>Descripcion</td>
                <td>Precio Unitario</td>
                <td>Asientos Disponibles</td>
                <td>Taquillas Numeradas</td>
                <td>Filas</td>
                <td>Columnas</td>
            </tr>
            <tr>
                <td>
                    <input type="text" name="" class="form-control" id="descripcionSector" value="">
                </td>
                <td>
                    <input type="text" name="" class="form-control" id="precio_unitario" value="">
                </td>
                <td>
                    <input type="text" name="" class="form-control" id="asientos_disponibles" value="">
                </td>
                <td>
                    <input type="checkbox" name="" class="form-control" id="es_sector_numerado" value="0"> 
                </td>
                <td>
                    <input type="number" name="" class="form-control" id="filas" value="">
                </td>
                <td>
                    <input type="number" name="" class="form-control" id="columnas" value="">
                </td>
                <td><input type="button" class="btn btn-primary" id="add" value="Añadir" /></td>
            </tr>
        </table>
        <div id="sectorItems" class="row"></div>
    </div>
</div>    
 

<div>
    @Html.ActionLink("Volver a la lista", "Index", null, new { @class="btn btn-primary" })
</div>
<div class="modal fade" id="modalGrabadoOK" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Grabado exitosamente</h4>
            </div>
            <div class="modal-body">
                El evento ha sido creado
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalGrabadoFail" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">ERROR</h4>
            </div>
            <div class="modal-body">
                Hubo un error al grabar, por favor revise sus datos.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalback" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel">Grabando...</h4>
            </div>
            <div class="modal-body">
                <div class="progress">
                    <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                        <span class="sr-only">100% Complete</span>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")


}
